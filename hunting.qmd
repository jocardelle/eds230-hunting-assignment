---
title: "Hunting and predator prey dynamics"
author: "Haylee Oyler & Josephine Cardelle"
format: 
  html:
    embed-resources: true
execute:
  warning: false
  message: false
editor_options: 
  chunk_output_type: console
---

```{r}
library(deSolve)
library(ggpubr)
library(tidyverse)
library(sensitivity)
library(lhs)
library(purrr)
library(ggpubr)
library(here)
```

```{r}
source(here("lotvhuntmod_haylee.R"))
```

## Part 2

**Rubric: Stability Metric**The metric captures some aspect of stability and the metric is implemented as a function - that can be applied to a time series (or multiple time series)

**Rubric: Exploration of Stability** compared the stability metric across different values of parameters used to define hunting. The comparison should be explicit in the Rmarkdown - it could be a graph or a table but some way to show how different hunting levels influence stability


We chose to define stability as prey populations above 200 and predator populations above 20 after 100 years. We kept the 10:1 ratio of prey:predator that matched the initial conditions we went over in class. It makes sense that there would be much more prey than predators, and we're hoping both populations would increase over time. 

Explore how different hunting levels and different minimum prey populations (before hunting is allowed) are likely to effect the stability of the populations of both predator and prey.

A key challenge is how you might want to define stability? It is up to you but you will need to write a sentence to explain why you chose the measure that you did. 

It is up to you how you "explore" hunting  - you can simply try different values of the parameters in your hunting model or do it more formally by running your model across a range of values. You could think about parameter interactions


```{r}
# Base parameters given in the assignment
base_params <- c(rprey = 0.95, alpha = 0.01, eff = 0.6, pmort = 0.4, K = 2000)
pars <- c(base_params, rhunt = 0.01, prey_min = 50)
currpop <- c(prey = 100, pred = 10)
days <- seq(0, 100, by = 1)

# Run the ode model
res <- ode(y = currpop, times = days, func = lotvhunt, parms = pars)
res_df <- as.data.frame(res)
colnames(res_df) <- c("time", "prey", "pred")

res_long <- res_df %>%
    pivot_longer(cols = c(prey, pred), names_to = "species", values_to = "population")

# View the population changes over time
ggplot(res_long, aes(x = time, y = population, color = species)) +
    geom_line() +
    labs(title = "Predator and Prey Populations Over Time",
        x = "Time (days)",
        y = "Population",
        color = "Species") +
    theme_minimal()
```


## Scenario Method

### Scenario 1: Low hunting rate, high threshold, Scenario 2: Reasonable hunting, Scenario 3: Higher hunting, Scenario 4: Very high hunting
```{r}
# Different values for parameters 
scenarios <- tibble(
  name = c("Low hunt", "Moderate hunt", "High Hunt", "Extreme Hunt"),
  rhunt = c(0.001, 0.01, 0.05, 0.1),
  prey_min = 50,
  # prey_min = c(50, 100, 150, 200)
)

days_short <- seq(1, 100, by = 1)

results <- scenarios %>%
  mutate(
    output = map2(rhunt, prey_min, function(rh, pm) {
      pars <- c(base_params, rhunt = rh, prey_min = pm)
      as.data.frame(ode(y = currpop, times = days_short, func = lotvhunt, parms = pars))
    })
  )


# Plot the scenarios
results_long <- results %>%
  mutate(name = factor(name, levels = name)) %>%
  unnest(output) %>%
  pivot_longer(cols = c(prey, pred), names_to = "species", values_to = "population")

ggplot(results_long, aes(x = time, y = population, color = species)) +
  geom_line() +
  facet_wrap(~ name, ncol = 2) +
  labs(title = "Population Dynamics Under Different Hunting Scenarios",
       x = "Time (days)", y = "Population") +
  theme_minimal()

# ggplot(results_long, aes(x = time, y = population, color = species)) +
#   geom_line() +
#   facet_wrap(~ prey_min, ncol = 2) +
#   labs(title = "Population Dynamics Under Different Hunting Scenarios",
#        x = "Time (days)", y = "Population") +
#   theme_minimal()
```

```{r}
# Different values for parameters 
scenarios_prey <- tibble(
  name = c("Low prey_min", "Moderate prey_min", "High prey_min", "Extreme prey_min"),
  prey_min = c(50, 100, 150, 200),
  rhunt = 0.001
)

days_short <- seq(1, 100, by = 1)

results_prey <- scenarios_prey %>%
  mutate(
    output = map2(prey_min, rhunt, function(rh, pm) {
      pars <- c(base_params, rhunt = rh, prey_min = pm)
      as.data.frame(ode(y = currpop, times = days, func = lotvhunt, parms = pars))
    })
  )


# Plot the scenarios
results_long_prey <- results_prey %>%
  mutate(name = factor(name, levels = name)) %>%
  unnest(output) %>%
  pivot_longer(cols = c(prey, pred), names_to = "species", values_to = "population")

ggplot(results_long_prey, aes(x = time, y = population, color = species)) +
  geom_line() +
  facet_wrap(~ prey_min, ncol = 2) +
  labs(title = "Population Dynamics Under Different Hunting Scenarios",
       x = "Time (days)", y = "Population") +
  theme_minimal()
```

```{r}
# set parameter list
pars <- data.frame(rprey = 0.1, alpha = 0.6, eff = 0.8, pmort = 0.4, K = 200, rhunt = 0.01, prey_min = 100)

# now lets try initial conditions that will be stable
preyi <- with(pars, pmort / (eff * alpha))
predi <- with(pars, rprey / alpha * (1 - (pmort / (eff * alpha *K))) - rhunt / alpha)

preyi
predi
# times when you want to evaluate
days <- seq(from = 1, to = 500)

# lets first see what happens when we start with 1 of each
currpop <- c(prey = 1, pred = 1)
# run our differential equation solver
res <- ode(func = lotvhunt, y = currpop, times = days, parms = pars)
# extract the results
res_smallstart <- as.data.frame(res) %>% gather(key = "animal", value = "pop", -time)
# graph both populations over time
p1 <- ggplot(res_smallstart, aes(time, pop, col = animal)) +
  geom_line()
p1

# lets first see what happens when we start our estimates of stable populations
stablepop <- c(prey = preyi, pred = predi)
res <- ode(func = lotvhunt, y = stablepop, times = days, parms = pars)
# estract the results
res_stablestart <- as.data.frame(res) %>% gather(key = "animal", value = "pop", -time)
# graph both populations over time
p2 <- ggplot(res_stablestart, aes(time, pop, col = animal)) +
  geom_line()
p2
```


